{% extends "StudiiFezabilitate/base_lucrare_SF.html" %}



{% block body %}

<div class="container-fluid">
    <h3 class="m-4">Lucrări filtrate — persoană de contact: {{ filtru_contact }}</h3>
    <div class="row">
        <div class="col-12">
            {% if lucrari %}
            {% for lucrare in lucrari %}
            <div class="card border-primary ms-4 me-4 mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-list fa-lg me-2"></i>
                        <span>Avize pentru lucrarea:</span>
                    </div>
                    <div class="flex-grow-1 text-center">
                        <div class="fw-bold fs-5">{{ lucrare.nume_intern }}</div>
                        {% if lucrare.certificat_urbanism and not lucrare.finalizata %}
                        <div class="mt-1">
                            <span class="badge rounded-pill {{ lucrare.certificat_urbanism.expiry_badge_class }}">
                                {{ lucrare.certificat_urbanism.expiry_badge_text }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        {% if lucrare.certificat_urbanism %}
                        <form action="{% url 'add_Avize' lucrare.id %}" method="POST" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">Adaugă aviz</button>
                        </form>
                        {% else %}
                        <a href="{% url 'add_CU' lucrare.id %}" class="btn btn-warning">Adaugă Certificat de urbanism</a>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body">
                    {% if lucrare.certificat_urbanism %}
                    {% with avize=lucrare.certificat_urbanism.avize_certificat.all %}
                    {% if avize %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm table-avize" style="table-layout: fixed; width: 100%">
                            <colgroup>
                                <col style="width: 20%"><!-- Aviz -->
                                <col style="width: 12%"><!-- GENEREAZĂ -->
                                <col style="width: 8%"><!-- Depus -->
                                <col style="width: 12%"><!-- Data depunerii -->
                                <col style="width: 8%"><!-- Primit -->
                                <col style="width: 30%"><!-- Detalii -->
                                <col style="width: 10%"><!-- ACȚIUNI -->
                            </colgroup>
                            <thead>
                                <tr>
                                    <th scope="col">Aviz</th>
                                    <th scope="col">GENEREAZĂ</th>
                                    <th scope="col">Depus</th>
                                    <th scope="col">Data depunerii</th>
                                    <th scope="col">Primit</th>
                                    <th scope="col">Detalii</th>
                                    <th scope="col" class="text-center">ACȚIUNI</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aviz in avize %}
                                <tr>
                                    <td>
                                        {% if aviz.is_overdue %}
                                        <span class="text-danger">{{ aviz.nume_aviz }}</span>
                                        {% else %}
                                        {{ aviz.nume_aviz }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a class="btn btn-primary me-1 btn-sm" href="{% url 'genereaza_aviz' lucrare.id aviz.id %}">
                                            Generează
                                        </a>
                                    </td>
                                    <td>{% if aviz.depus %}✅ Da{% else %}❌ Nu{% endif %}</td>
                                    <td>{{aviz.data_depunere|date:"d.m.Y"}}</td>
                                    <td>{% if aviz.primit %}✅ Da{% else %}❌ Nu{% endif %}</td>
                                    <td>{{ aviz.descriere_aviz }}</td>
                                    <td class="text-end">
                                        <button type="button" class="btn btn-success me-1 btn-sm" data-bs-toggle="modal" data-bs-target="#myModal{{aviz.id}}">
                                            <i class="fa-solid fa-circle-info fa-lg"></i>
                                        </button>

                                        <!-- Modal - View Lucrare -->
                                        <div class="modal" id="myModal{{aviz.id}}" tabindex="-1" aria-labelledby="myModalLabel{{aviz.id}}" aria-hidden="true">
                                            <div class="modal-dialog modal-lg" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="myModalLabel{{aviz.id}}">
                                                            Aviz: {{aviz.nume_aviz}} pentru
                                                            {{aviz.certificat_urbanism.lucrare.nume_intern}}
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true"></span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <ul class="list-unstyled">
                                                            <li> Depus: <strong>
                                                                    {% if aviz.depus == True %}✅
                                                                    Da
                                                                    {% else %} ❌ Nu
                                                                    {% endif %}
                                                                </strong>
                                                            </li>
                                                            <li> Data depunere:
                                                                <strong>{{aviz.data_depunere|date:"d.m.Y"}}</strong>
                                                            </li>
                                                            <li> Primit: <strong>
                                                                    {% if aviz.primit == True %}✅
                                                                    Da
                                                                    {% else %} ❌ Nu
                                                                    {% endif %}
                                                                </strong>
                                                                </strong></li>
                                                            <li> Număr aviz:
                                                                <strong>{{aviz.numar_aviz}}</strong>
                                                            </li>
                                                            <li> Data aviz:
                                                                <strong>{{aviz.data_aviz|date:"d.m.Y"}}</strong>
                                                            </li>
                                                            <li> Cost net:
                                                                <strong>{{ aviz.cost_net }}</strong>
                                                            </li>
                                                            <li> Cost TVA:
                                                                <strong>{{ aviz.cost_tva }}</strong>
                                                            </li>
                                                            <li> Cost Total:
                                                                <strong>{{ aviz.cost_total }}</strong>
                                                            </li>

                                                        </ul>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Închide</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- aici se termina modalul -->


                                        <!-- aici e butonul pentru a edita -->

                                        <a class="btn btn-warning me-1 btn-sm" href="{% url 'edit_aviz' lucrare.id aviz.id %}">Editează
                                        </a>

                                        <!-- aici e butonul pentru a sterge -->

                                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#delete{{aviz.id}}">
                                            <i class="fa-solid fa-trash-can fa-lg"></i>
                                        </button>

                                        <!-- Modal - Delete Lucrare -->
                                        <div class="modal" id="delete{{aviz.id}}" tabindex="-1" aria-labelledby="deleteModalLabel{{aviz.id}}" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deleteModalLabel{{aviz.id}}">
                                                            {{aviz.nume_aviz}} pentru
                                                            {{aviz.certificat_urbanism.lucrare.nume_intern}}
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Închide">
                                                            <span aria-hidden="true"></span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p> Ești sigur că vrei să ștergi avizul?

                                                        </p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <form action="{% url 'delete_aviz' lucrare.id aviz.id %}" method="POST">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger">Șterge</button>
                                                        </form>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Renunță</button>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-primary">Nu sunt avize asociate acestei lucrări
                        <form action="{% url 'add_Avize' lucrare.id %}" method="POST" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-sm">Adaugă aviz</button>
                        </form>
                    </div>
                    {% endif %}
                    {% endwith %}
                    {% else %}
                    <div class="alert alert-warning">Lucrarea nu are Certificat de urbanism încă.
                        <a href="{% url 'add_CU' lucrare.id %}" class="btn btn-warning btn-sm ms-2">Adaugă CU</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-primary ms-4 me-4 mb-4">Nu sunt lucrări pentru {{ filtru_contact }}</div>
            {% endif %}

            <div class="ms-4 me-4 mb-4">
                <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left"></i> Înapoi la toate lucrările
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}